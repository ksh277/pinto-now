import React, { useState, useCallback, useRef, useEffect } from "react";
import { Undo2, Redo2, Download, Save, X, Upload, Type, Square, Circle, Move, Trash2, RotateCw, Eraser } from "lucide-react";
import { autoResizeImage, getCenterPosition, loadImageFile, removeImageBackground, optimizeImage, calculateCanvasSizeForImage, generateCanvasShapeMask, analyzeImagePixelBounds } from "../utils/imageUtils";

// Utility functions
const cn = (...classes) => classes.filter(Boolean).join(' ');

// UI Components (Í∏∞Ï°¥Í≥º ÎèôÏùº)
const Button = ({ children, variant = "default", size = "sm", className = "", disabled = false, onClick, onMouseDown, title, ...props }) => {
  const baseClasses = "inline-flex items-center justify-center rounded-md font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background";
  
  const variants = {
    default: "bg-primary text-primary-foreground hover:bg-primary/90 bg-gray-700 text-white hover:bg-gray-600",
    outline: "border border-input hover:bg-accent hover:text-accent-foreground border-gray-600 text-gray-300 hover:bg-gray-700 hover:text-white",
    ghost: "hover:bg-accent hover:text-accent-foreground hover:bg-gray-700",
    destructive: "bg-red-600 text-white hover:bg-red-700"
  };
  
  const sizes = {
    sm: "h-9 px-3 text-sm",
    default: "h-10 py-2 px-4"
  };
  
  return (
    <button
      className={cn(baseClasses, variants[variant], sizes[size], className)}
      disabled={disabled}
      onClick={onClick}
      onMouseDown={onMouseDown}
      title={title}
      {...props}
    >
      {children}
    </button>
  );
};

const Input = ({ className = "", type = "text", ...props }) => {
  return (
    <input
      type={type}
      className={cn(
        "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  );
};

const Label = ({ className = "", ...props }) => {
  return (
    <label
      className={cn("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70", className)}
      {...props}
    />
  );
};

const Select = ({ children, value, onValueChange, disabled = false }) => {
  return (
    <div className="relative">
      <select
        value={value}
        onChange={(e) => onValueChange && onValueChange(e.target.value)}
        disabled={disabled}
        className="w-full h-10 px-3 py-2 text-sm bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
      >
        {children}
      </select>
    </div>
  );
};

// Toast hook (Í∏∞Ï°¥Í≥º ÎèôÏùº)
const useToast = () => {
  const [toasts, setToasts] = useState([]);
  
  const toast = useCallback(({ title, description, variant = "default" }) => {
    const id = Date.now();
    const newToast = { id, title, description, variant };
    setToasts(prev => [...prev, newToast]);
    
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, 3000);
  }, []);
  
  return { toast, toasts };
};

// Constants (Í∏∞Ï°¥Í≥º ÎèôÏùº)
const PRODUCT_PRESETS = {
  keyring: [
    { name: "Ïä§ÌÄòÏñ¥ ÌÇ§ÎßÅ", width: 50, height: 50 },
    { name: "ÏõêÌòï ÌÇ§ÎßÅ", width: 60, height: 60 },
    { name: "ÌïòÌä∏ ÌÇ§ÎßÅ", width: 55, height: 50 },
  ],
  stand: [
    { name: "Ïä§ÎßàÌä∏ÌÜ° ÏõêÌòï", width: 40, height: 40 },
    { name: "Ïä§ÎßàÌä∏ÌÜ° ÏÇ¨Í∞Å", width: 45, height: 45 },
    { name: "Ïä§ÎßàÌä∏ÌÜ° ÌïòÌä∏", width: 50, height: 45 },
  ],
  photocard: [
    { name: "Ìè¨ÌÜ†Ïπ¥Îìú ÌôÄÎçî", width: 65, height: 100 },
    { name: "ÎØ∏Îãà Ìè¨ÌÜ†Ïπ¥Îìú", width: 54, height: 86 },
    { name: "ÎåÄÌòï Ìè¨ÌÜ†Ïπ¥Îìú", width: 70, height: 105 },
  ],
  sticker: [
    { name: "ÏõêÌòï Ïä§Ìã∞Ïª§", width: 50, height: 50 },
    { name: "ÏÇ¨Í∞Å Ïä§Ìã∞Ïª§", width: 60, height: 40 },
    { name: "ÎåÄÌòï Ïä§Ìã∞Ïª§", width: 80, height: 60 },
  ],
  phonecase: [
    { name: "ÏïÑÏù¥Ìè∞ ÏºÄÏù¥Ïä§", width: 80, height: 160 },
    { name: "Í∞§Îü≠Ïãú ÏºÄÏù¥Ïä§", width: 85, height: 165 },
    { name: "ÌÉúÎ∏îÎ¶ø ÏºÄÏù¥Ïä§", width: 200, height: 280 },
  ],
  tshirt: [
    { name: "Ìã∞ÏÖîÏ∏† ÏïûÎ©¥", width: 200, height: 250 },
    { name: "Ìã∞ÏÖîÏ∏† Îí∑Î©¥", width: 200, height: 250 },
    { name: "ÌõÑÎìúÌã∞ ÏïûÎ©¥", width: 220, height: 280 },
  ],
};

const MM_TO_PX_RATIO = 10;

// Í∞úÏÑ†Îêú ImageTools Ïª¥Ìè¨ÎÑåÌä∏
function ImageTools({ selectedImage, onUpdateImage, onRemoveBackground, onCanvasResize, canvasSize, disabled }) {
  const [isProcessing, setIsProcessing] = useState(false);
  const [isResizingCanvas, setIsResizingCanvas] = useState(false);
  
  const handleRemoveBackground = async () => {
    if (!selectedImage || isProcessing) return;
    
    setIsProcessing(true);
    try {
      console.log('üé® Î∞∞Í≤Ω Ï†úÍ±∞ ÏãúÏûë...', selectedImage);
      // ÏõêÎ≥∏ ÌååÏùº Í∞ùÏ≤¥Í∞Ä ÏûàÏúºÎ©¥ ÏÑúÎ≤Ñ API ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïù¥ÎìúÎßå
      const processedSrc = await removeImageBackground(selectedImage.src, selectedImage.originalFile);
      onUpdateImage(selectedImage.id, { src: processedSrc });
      console.log('‚úÖ Î∞∞Í≤Ω Ï†úÍ±∞ ÏôÑÎ£å');
    } catch (error) {
      console.error('‚ùå Î∞∞Í≤Ω Ï†úÍ±∞ Ïã§Ìå®:', error);
      // Toast ÏïåÎ¶º Ï∂îÍ∞Ä
    } finally {
      setIsProcessing(false);
    }
  };

  const handleResizeCanvasToFitImage = async () => {
    if (!selectedImage || isResizingCanvas) return;
    
    setIsResizingCanvas(true);
    try {
      console.log('üéØ GitHub Ïª§ÎÆ§ÎãàÌã∞ Î∞©Ïãù: ÌîΩÏÖÄ Î∂ÑÏÑù + Î∞îÏö¥Îî© Î∞ïÏä§ + Ïó¨Î∞±');
      console.log('üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥:', selectedImage);
      
      // 1Îã®Í≥Ñ: Î∞∞Í≤Ω Ï†úÍ±∞ (ÌïÑÏöîÏãú)
      let processedImageSrc = selectedImage.src;
      let isBackgroundRemoved = selectedImage.src.startsWith('data:image') && selectedImage.src.includes('base64');
      
      if (!isBackgroundRemoved && selectedImage.originalFile) {
        console.log('üîÑ 1Îã®Í≥Ñ: Î∞∞Í≤Ω Ï†úÍ±∞ Ï§ë...');
        try {
          processedImageSrc = await removeImageBackground(selectedImage.src, selectedImage.originalFile);
          // Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
          onUpdateImage(selectedImage.id, { src: processedImageSrc });
          console.log('‚úÖ Î∞∞Í≤Ω Ï†úÍ±∞ ÏôÑÎ£å');
        } catch (error) {
          console.warn('‚ö†Ô∏è Î∞∞Í≤Ω Ï†úÍ±∞ Ïã§Ìå®, ÏõêÎ≥∏ ÏÇ¨Ïö©:', error.message);
        }
      }
      
      // 2Îã®Í≥Ñ: ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ïã§Ï†ú ÌîΩÏÖÄ Î∞îÏö¥Îî© Î∞ïÏä§ Î∂ÑÏÑù
      console.log('üîÑ 2Îã®Í≥Ñ: ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÌîΩÏÖÄ Î∂ÑÏÑù Ï§ë...');
      const pixelAnalysis = await analyzeImagePixelBounds(processedImageSrc);
      console.log('üìä ÌîΩÏÖÄ Î∂ÑÏÑù Í≤∞Í≥º:', pixelAnalysis);
      
      // 3Îã®Í≥Ñ: GitHub Ïª§ÎÆ§ÎãàÌã∞ Î∞©Ïãù - Î∞îÏö¥Îî© Î∞ïÏä§ + Ïó¨Î∞± Í≥ÑÏÇ∞
      const margin = Math.round(1 * (96 / 2.54)); // 1cm ‚âà 38ÌîΩÏÖÄ at 96 DPI
      const bbox = pixelAnalysis.boundingBox;
      
      console.log('üìè ÏõêÎ≥∏ Î∞îÏö¥Îî© Î∞ïÏä§:', bbox);
      console.log('üìê Ïó¨Î∞± ÌÅ¨Í∏∞:', margin + 'px (' + (margin / (96 / 2.54)).toFixed(1) + 'cm)');
      
      // GitHub Î∞©Ïãù: Ïó¨Î∞± Ï∂îÍ∞Ä
      const x_new = Math.max(0, bbox.x - margin);
      const y_new = Math.max(0, bbox.y - margin);
      const w_new = bbox.width + (2 * margin);
      const h_new = bbox.height + (2 * margin);
      
      console.log('üìè Ïó¨Î∞± Ï∂îÍ∞Ä ÌõÑ:', { x: x_new, y: y_new, width: w_new, height: h_new });
      
      // 4Îã®Í≥Ñ: Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î°ú Î≥ÄÌôò
      const newCanvasSize = {
        width: Math.round(w_new),
        height: Math.round(h_new),
        widthMM: Math.round(w_new / (96 / 25.4)), // 96 DPI to mm
        heightMM: Math.round(h_new / (96 / 25.4))
      };
      
      console.log('üé® ÏÉà Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞:', newCanvasSize);
      
      // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω
      onCanvasResize && onCanvasResize(newCanvasSize, null);
      
      console.log('‚úÖ GitHub Ïª§ÎÆ§ÎãàÌã∞ Î∞©Ïãù ÏôÑÎ£å!');
      console.log('- Î∞©Î≤ï: ÌîΩÏÖÄ Î∂ÑÏÑù ‚Üí Î∞îÏö¥Îî© Î∞ïÏä§ ‚Üí 1cm Ïó¨Î∞± Ï∂îÍ∞Ä');
      console.log('- Ïã†Î¢∞ÎèÑ:', pixelAnalysis.confidence);
      console.log('- ÌîΩÏÖÄ Ïàò:', pixelAnalysis.pixelCount);
      
    } catch (error) {
      console.error('‚ùå Ïä§ÎßàÌä∏ Ï∫îÎ≤ÑÏä§ Ï°∞Ï†à Ïã§Ìå®:', error);
      // Ìè¥Î∞±: Í∏∞Î≥∏ Ï∫îÎ≤ÑÏä§ ÎßûÏ∂§
      try {
        handleAutoFit();
      } catch (fallbackError) {
        console.error('‚ùå Ìè¥Î∞±ÎèÑ Ïã§Ìå®:', fallbackError);
      }
    } finally {
      setIsResizingCanvas(false);
    }
  };
  
  const handleAutoFit = () => {
    if (!selectedImage || !canvasSize) return;
    
    const img = new Image();
    img.onload = () => {
      const resizedDimensions = autoResizeImage(
        { width: img.width, height: img.height },
        canvasSize,
        0.8
      );
      
      const centerPosition = getCenterPosition(resizedDimensions, canvasSize);
      
      onUpdateImage(selectedImage.id, {
        ...resizedDimensions,
        ...centerPosition
      });
    };
    img.src = selectedImage.src;
  };
  
  if (!selectedImage || selectedImage.type !== 'image') {
    return null;
  }
  
  return (
    <div className="p-4 border-b border-gray-700">
      <div className="flex items-center space-x-2 mb-3">
        <span className="text-sm font-medium text-white">Ïù¥ÎØ∏ÏßÄ ÎèÑÍµ¨</span>
      </div>
      <div className="space-y-2">
        <Button
          variant="outline"
          size="sm"
          onClick={handleAutoFit}
          disabled={disabled}
          className="w-full text-xs hover:bg-blue-600 hover:text-white border-blue-400 text-blue-400"
        >
          Ï∫îÎ≤ÑÏä§Ïóê ÎßûÏ∂§
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={handleRemoveBackground}
          disabled={disabled || isProcessing}
          className="w-full text-xs hover:bg-purple-600 hover:text-white border-purple-400 text-purple-400"
        >
          <Eraser className="w-3 h-3 mr-1" />
          {isProcessing ? 'Ï≤òÎ¶¨Ï§ë...' : 'Î∞∞Í≤Ω Ï†úÍ±∞'}
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={handleResizeCanvasToFitImage}
          disabled={disabled || isResizingCanvas}
          className="w-full text-xs hover:bg-yellow-600 hover:text-white border-yellow-400 text-yellow-400"
        >
          üéØ
          {isResizingCanvas ? 'ÌîΩÏÖÄ Î∂ÑÏÑùÏ§ë...' : 'Ï†ïÌôïÌïú Ï∫îÎ≤ÑÏä§ Ï°∞Ï†à'}
        </Button>
        <div className="text-xs text-gray-400 mt-1">
          ÌîΩÏÖÄ Î∂ÑÏÑù ‚Üí Î∞îÏö¥Îî© Î∞ïÏä§ ‚Üí 1cm Ïó¨Î∞± Ï∂îÍ∞Ä
        </div>
      </div>
    </div>
  );
}

// Í∞úÏÑ†Îêú SizeSelector Component
function SizeSelector({ productType, onSizeSet }) {
  const [selectedPreset, setSelectedPreset] = useState("");
  const [customWidth, setCustomWidth] = useState(50);
  const [customHeight, setCustomHeight] = useState(50);
  const [mode, setMode] = useState("preset");

  const presets = PRODUCT_PRESETS[productType] || PRODUCT_PRESETS.keyring;

  const handlePresetSelect = (presetName) => {
    const preset = presets.find((p) => p.name === presetName);
    if (preset) {
      setSelectedPreset(presetName);
      onSizeSet({
        width: preset.width * MM_TO_PX_RATIO,
        height: preset.height * MM_TO_PX_RATIO,
        widthMM: preset.width,
        heightMM: preset.height,
      });
    }
  };

  const handleCustomSize = () => {
    if (customWidth > 0 && customHeight > 0) {
      onSizeSet({
        width: customWidth * MM_TO_PX_RATIO,
        height: customHeight * MM_TO_PX_RATIO,
        widthMM: customWidth,
        heightMM: customHeight,
      });
    }
  };

  const handleModeChange = (newMode) => {
    setMode(newMode);
    setSelectedPreset("");
  };

  return (
    <div className="space-y-4">
      <div className="space-y-2">
        <Label className="text-xs text-gray-300">ÌÅ¨Í∏∞ ÏÑ§Ï†ï Î∞©Ïãù</Label>
        <div className="flex space-x-2">
          <Button
            variant={mode === "preset" ? "default" : "outline"}
            size="sm"
            onClick={() => handleModeChange("preset")}
            onMouseDown={(e) => e.preventDefault()}
            className={cn("flex-1 text-xs", mode !== "preset" && "border-gray-600 text-gray-300")}
          >
            ÌîÑÎ¶¨ÏÖã
          </Button>
          <Button
            variant={mode === "custom" ? "default" : "outline"}
            size="sm"
            onClick={() => handleModeChange("custom")}
            onMouseDown={(e) => e.preventDefault()}
            className={cn("flex-1 text-xs", mode !== "custom" && "border-gray-600 text-gray-300")}
          >
            ÏßÅÏ†ëÏûÖÎ†•
          </Button>
        </div>
      </div>

      {mode === "preset" ? (
        <div className="space-y-3">
          <Label className="text-xs text-gray-300">Ï†úÌíà ÌÅ¨Í∏∞ ÏÑ†ÌÉù</Label>
          <Select value={selectedPreset} onValueChange={handlePresetSelect} disabled={mode !== "preset"}>
            <option value="">ÌÅ¨Í∏∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
            {presets.map((preset) => (
              <option key={preset.name} value={preset.name}>
                {preset.name} ({preset.width}√ó{preset.height}mm)
              </option>
            ))}
          </Select>
        </div>
      ) : (
        <div className="space-y-3">
          <Label className="text-xs text-gray-300">ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÌÅ¨Í∏∞ (mm)</Label>
          <div className="grid grid-cols-2 gap-2">
            <div>
              <Label className="text-xs text-gray-400">Í∞ÄÎ°ú</Label>
              <Input
                type="number"
                value={customWidth}
                onChange={(e) => setCustomWidth(Number(e.target.value) || 0)}
                min="10"
                max="500"
                disabled={mode !== "custom"}
                className={cn(
                  "bg-gray-700 border-gray-600 text-white text-xs",
                  mode !== "custom" && "disabled:opacity-30 disabled:cursor-not-allowed",
                  mode === "custom" && "focus:border-blue-400 focus:ring-1 focus:ring-blue-400"
                )}
                placeholder="Í∞ÄÎ°ú (mm)"
              />
            </div>
            <div>
              <Label className="text-xs text-gray-400">ÏÑ∏Î°ú</Label>
              <Input
                type="number"
                value={customHeight}
                onChange={(e) => setCustomHeight(Number(e.target.value) || 0)}
                min="10"
                max="500"
                disabled={mode !== "custom"}
                className={cn(
                  "bg-gray-700 border-gray-600 text-white text-xs",
                  mode !== "custom" && "disabled:opacity-30 disabled:cursor-not-allowed",
                  mode === "custom" && "focus:border-blue-400 focus:ring-1 focus:ring-blue-400"
                )}
                placeholder="ÏÑ∏Î°ú (mm)"
              />
            </div>
          </div>
          <Button
            variant="outline"
            size="sm"
            onClick={handleCustomSize}
            disabled={mode !== "custom" || customWidth <= 0 || customHeight <= 0}
            className={cn(
              "w-full text-xs",
              mode !== "custom" || customWidth <= 0 || customHeight <= 0
                ? "disabled:opacity-30 disabled:cursor-not-allowed"
                : "hover:bg-blue-600 hover:text-white border-blue-400 text-blue-400"
            )}
          >
            ÌÅ¨Í∏∞ Ï†ÅÏö©
          </Button>
        </div>
      )}

      <div className="text-xs text-gray-400 mt-2">
        {mode === "preset" && selectedPreset && (
          <div>
            ÏÑ†ÌÉùÎêú ÌÅ¨Í∏∞: {presets.find((p) => p.name === selectedPreset)?.width}√ó{presets.find((p) => p.name === selectedPreset)?.height}mm
          </div>
        )}
        {mode === "custom" && customWidth > 0 && customHeight > 0 && (
          <div>ÏÑ§Ï†ïÎê† ÌÅ¨Í∏∞: {customWidth}√ó{customHeight}mm</div>
        )}
        {mode === "custom" && (customWidth <= 0 || customHeight <= 0) && (
          <div className="text-yellow-400">Í∞ÄÎ°úÏôÄ ÏÑ∏Î°ú ÌÅ¨Í∏∞Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (10-500mm)</div>
        )}
      </div>
    </div>
  );
}

// Í∞úÏÑ†Îêú DraggableElement Component  
function DraggableElement({ element, isSelected, onSelect, onUpdate, onDelete, canvasBounds }) {
  const [isDragging, setIsDragging] = useState(false);
  const [isResizing, setIsResizing] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const [resizeStart, setResizeStart] = useState(null);
  const elementRef = useRef(null);

  const handlePointerDown = useCallback((e) => {
    if (e.target === elementRef.current || elementRef.current?.contains(e.target)) {
      e.preventDefault();
      setIsDragging(true);
      setDragStart({ x: e.clientX - element.x, y: e.clientY - element.y });
      onSelect(element.id);
    }
  }, [element, onSelect]);

  const handleResizeStart = useCallback((e, handle) => {
    e.preventDefault();
    e.stopPropagation();
    setIsResizing(true);
    setResizeStart({
      handle,
      startX: e.clientX,
      startY: e.clientY,
      startWidth: element.width,
      startHeight: element.height,
      startX_elem: element.x,
      startY_elem: element.y
    });
  }, [element]);

  useEffect(() => {
    if (isDragging) {
      const handleGlobalPointerMove = (e) => {
        const newX = Math.max(0, Math.min(canvasBounds.width - element.width, e.clientX - dragStart.x));
        const newY = Math.max(0, Math.min(canvasBounds.height - element.height, e.clientY - dragStart.y));
        onUpdate(element.id, { x: newX, y: newY });
      };

      const handleGlobalPointerUp = () => {
        setIsDragging(false);
      };

      document.addEventListener('pointermove', handleGlobalPointerMove);
      document.addEventListener('pointerup', handleGlobalPointerUp);

      return () => {
        document.removeEventListener('pointermove', handleGlobalPointerMove);
        document.removeEventListener('pointerup', handleGlobalPointerUp);
      };
    }
  }, [isDragging, dragStart, element, canvasBounds, onUpdate]);

  useEffect(() => {
    if (isResizing && resizeStart) {
      const handleGlobalPointerMove = (e) => {
        const deltaX = e.clientX - resizeStart.startX;
        const deltaY = e.clientY - resizeStart.startY;
        
        let newWidth = resizeStart.startWidth;
        let newHeight = resizeStart.startHeight;
        let newX = resizeStart.startX_elem;
        let newY = resizeStart.startY_elem;
        
        // ÎπÑÏú® Ïú†ÏßÄ (Shift ÌÇ§Î•º ÎàÑÎ•¥Í±∞ÎÇò Ïù¥ÎØ∏ÏßÄÏù∏ Í≤ΩÏö∞)
        const maintainRatio = e.shiftKey || element.type === 'image';
        const aspectRatio = resizeStart.startWidth / resizeStart.startHeight;
        
        switch (resizeStart.handle) {
          case 'se':
            newWidth = Math.max(20, resizeStart.startWidth + deltaX);
            newHeight = maintainRatio ? newWidth / aspectRatio : Math.max(20, resizeStart.startHeight + deltaY);
            break;
          case 'sw':
            newWidth = Math.max(20, resizeStart.startWidth - deltaX);
            newHeight = maintainRatio ? newWidth / aspectRatio : Math.max(20, resizeStart.startHeight + deltaY);
            newX = resizeStart.startX_elem + (resizeStart.startWidth - newWidth);
            break;
          case 'ne':
            newWidth = Math.max(20, resizeStart.startWidth + deltaX);
            newHeight = maintainRatio ? newWidth / aspectRatio : Math.max(20, resizeStart.startHeight - deltaY);
            newY = resizeStart.startY_elem + (resizeStart.startHeight - newHeight);
            break;
          case 'nw':
            newWidth = Math.max(20, resizeStart.startWidth - deltaX);
            newHeight = maintainRatio ? newWidth / aspectRatio : Math.max(20, resizeStart.startHeight - deltaY);
            newX = resizeStart.startX_elem + (resizeStart.startWidth - newWidth);
            newY = resizeStart.startY_elem + (resizeStart.startHeight - newHeight);
            break;
        }
        
        // Ï∫îÎ≤ÑÏä§ Í≤ΩÍ≥Ñ ÌôïÏù∏
        if (newX >= 0 && newY >= 0 && newX + newWidth <= canvasBounds.width && newY + newHeight <= canvasBounds.height) {
          onUpdate(element.id, { 
            width: newWidth, 
            height: newHeight,
            x: newX,
            y: newY 
          });
        }
      };

      const handleGlobalPointerUp = () => {
        setIsResizing(false);
        setResizeStart(null);
      };

      document.addEventListener('pointermove', handleGlobalPointerMove);
      document.addEventListener('pointerup', handleGlobalPointerUp);

      return () => {
        document.removeEventListener('pointermove', handleGlobalPointerMove);
        document.removeEventListener('pointerup', handleGlobalPointerUp);
      };
    }
  }, [isResizing, resizeStart, element, canvasBounds, onUpdate]);

  const resizeHandles = [
    { id: 'nw', className: 'cursor-nw-resize', style: { top: -6, left: -6 } },
    { id: 'ne', className: 'cursor-ne-resize', style: { top: -6, right: -6 } },
    { id: 'sw', className: 'cursor-sw-resize', style: { bottom: -6, left: -6 } },
    { id: 'se', className: 'cursor-se-resize', style: { bottom: -6, right: -6 } },
  ];

  return (
    <div
      ref={elementRef}
      className={`absolute select-none touch-none ${isSelected ? 'z-10' : 'z-0'}`}
      style={{
        left: element.x,
        top: element.y,
        width: element.width,
        height: element.height,
        transform: `rotate(${element.rotation || 0}deg)`,
        transformOrigin: 'center center'
      }}
      onPointerDown={handlePointerDown}
    >
      {/* Element Content */}
      {element.type === 'image' && element.src && (
        <img
          src={element.src}
          alt=""
          className={cn(
            "w-full h-full object-contain border-2",
            isDragging ? 'cursor-grabbing' : 'cursor-grab',
            isSelected ? 'border-blue-500' : 'border-transparent'
          )}
          draggable={false}
        />
      )}
      
      {element.type === 'text' && (
        <div
          className={cn(
            "w-full h-full flex items-center justify-center border-2 bg-transparent",
            isDragging ? 'cursor-grabbing' : 'cursor-grab',
            isSelected ? 'border-blue-500' : 'border-transparent'
          )}
          style={{
            fontSize: element.fontSize || 24,
            fontFamily: element.fontFamily || 'Pretendard',
            fontWeight: element.fontWeight || 'normal',
            fontStyle: element.fontStyle || 'normal',
            color: element.color || '#000000',
            userSelect: 'none'
          }}
        >
          {element.text}
        </div>
      )}

      {/* Selection Outline */}
      {isSelected && (
        <div className="absolute inset-0 border-2 border-dashed border-blue-400 pointer-events-none" />
      )}

      {/* Resize Handles */}
      {isSelected && (
        <>
          {resizeHandles.map((handle) => (
            <div
              key={handle.id}
              className={cn(
                "absolute w-3 h-3 bg-blue-500 border-2 border-white rounded-full hover:bg-blue-600 transition-colors",
                handle.className
              )}
              style={handle.style}
              onPointerDown={(e) => handleResizeStart(e, handle.id)}
            />
          ))}
          
          {/* Control Buttons */}
          <div className="absolute -top-12 left-0 flex items-center space-x-1 bg-white rounded-lg shadow-lg p-1">
            <Button
              size="sm"
              variant="ghost"
              onClick={() => onUpdate(element.id, { rotation: (element.rotation || 0) + 90 })}
              className="h-8 w-8 p-0"
              title="ÌöåÏ†Ñ"
            >
              <RotateCw className="h-3 w-3" />
            </Button>
            <Button
              size="sm"
              variant="ghost"
              onClick={() => onDelete(element.id)}
              className="h-8 w-8 p-0 text-red-500 hover:text-red-700"
              title="ÏÇ≠Ï†ú"
            >
              <Trash2 className="h-3 w-3" />
            </Button>
          </div>
        </>
      )}
    </div>
  );
}

// ÎÇòÎ®∏ÏßÄ Ïª¥Ìè¨ÎÑåÌä∏Îì§ÏùÄ Í∏∞Ï°¥Í≥º ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ...
// (DraggableShape, ProductEditor, ToastContainer Îì±)

// Keyring Ring Component
function KeyringRing({ canvasSize, onPositionChange, isVisible = false }) {
  const [position, setPosition] = useState({ angle: 0 }); // Í∞ÅÎèÑÎ°ú ÏúÑÏπò Í¥ÄÎ¶¨
  const [isDragging, setIsDragging] = useState(false);
  const ringRef = useRef(null);

  const ringDiameter = 1.5 * 10; // 1.5cm = 15px (MM_TO_PX_RATIO = 10)
  const ringRadius = ringDiameter / 2;
  const ringThickness = 2; // Í≥†Î¶¨ ÎëêÍªò

  // Ï∫îÎ≤ÑÏä§ Ï§ëÏã¨Ï†êÍ≥º Î∞òÏßÄÎ¶Ñ Í≥ÑÏÇ∞
  const canvasCenterX = canvasSize.width / 2;
  const canvasCenterY = canvasSize.height / 2;
  const canvasRadius = Math.min(canvasSize.width, canvasSize.height) / 2 + ringRadius + 5; // Ï∫îÎ≤ÑÏä§ Í∞ÄÏû•ÏûêÎ¶¨ÏóêÏÑú ÏïΩÍ∞Ñ Î∞îÍπ•Ï™Ω

  // Í∞ÅÎèÑÏóê Îî∞Î•∏ Í≥†Î¶¨Ïùò Ïã§Ï†ú ÏúÑÏπò Í≥ÑÏÇ∞
  const ringX = canvasCenterX + Math.cos(position.angle) * canvasRadius - ringRadius;
  const ringY = canvasCenterY + Math.sin(position.angle) * canvasRadius - ringRadius;

  const handleMouseDown = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(true);
  }, []);

  const handleMouseMove = useCallback((e) => {
    if (!isDragging || !canvasSize) return;

    const canvasRect = ringRef.current.closest('.canvas-container').getBoundingClientRect();
    const canvasCenterAbsX = canvasRect.left + canvasSize.width / 2;
    const canvasCenterAbsY = canvasRect.top + canvasSize.height / 2;
    
    // ÎßàÏö∞Ïä§ ÏúÑÏπòÏóêÏÑú Ï∫îÎ≤ÑÏä§ Ï§ëÏã¨ÍπåÏßÄÏùò Í∞ÅÎèÑ Í≥ÑÏÇ∞
    const deltaX = e.clientX - canvasCenterAbsX;
    const deltaY = e.clientY - canvasCenterAbsY;
    const angle = Math.atan2(deltaY, deltaX);

    setPosition({ angle });
    onPositionChange && onPositionChange({ angle, x: ringX, y: ringY });
  }, [isDragging, canvasSize, ringX, ringY, onPositionChange]);

  const handleMouseUp = useCallback(() => {
    setIsDragging(false);
  }, []);

  useEffect(() => {
    if (isDragging) {
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDragging, handleMouseMove, handleMouseUp]);

  if (!isVisible || !canvasSize) return null;

  return (
    <div
      ref={ringRef}
      className={`absolute cursor-grab ${isDragging ? 'cursor-grabbing' : ''}`}
      style={{
        left: ringX,
        top: ringY,
        width: ringDiameter,
        height: ringDiameter,
        zIndex: 10
      }}
      onMouseDown={handleMouseDown}
    >
      {/* ÎèÑÎÑõ Î™®Ïñë Í≥†Î¶¨ */}
      <svg
        width={ringDiameter}
        height={ringDiameter}
        className="drop-shadow-md hover:drop-shadow-lg transition-all"
      >
        <defs>
          <radialGradient id="ringGradient" cx="30%" cy="30%">
            <stop offset="0%" stopColor="#fbbf24" />
            <stop offset="100%" stopColor="#f59e0b" />
          </radialGradient>
        </defs>
        {/* Ïô∏Î∂Ä Ïõê */}
        <circle
          cx={ringRadius}
          cy={ringRadius}
          r={ringRadius - 1}
          fill="url(#ringGradient)"
          stroke="#d97706"
          strokeWidth="0.5"
        />
        {/* ÎÇ¥Î∂Ä Íµ¨Î©ç */}
        <circle
          cx={ringRadius}
          cy={ringRadius}
          r={ringRadius - ringThickness}
          fill="transparent"
          stroke="#d97706"
          strokeWidth="0.5"
        />
      </svg>
      
      {/* ÎìúÎûòÍ∑∏ ÌûåÌä∏ */}
      {isDragging && (
        <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded whitespace-nowrap">
          Í≥†Î¶¨ ÏúÑÏπò Ï°∞Ï†à
        </div>
      )}
    </div>
  );
}

// Í∞úÏÑ†Îêú Main Editor Component
export default function ImprovedEditorLayout() {
  const { toast, toasts } = useToast();
  const fileInputRef = useRef(null);
  const canvasRef = useRef(null);

  // Canvas and size state
  const [canvasSize, setCanvasSize] = useState(null);
  const [canvasMask, setCanvasMask] = useState(null); // Ï∫îÎ≤ÑÏä§ Î™®Ïñë ÎßàÏä§ÌÅ¨
  const [elements, setElements] = useState([]);
  const [selectedElement, setSelectedElement] = useState(null);
  const [history, setHistory] = useState([[]]);
  const [historyIndex, setHistoryIndex] = useState(0);
  
  // Keyring state
  const [showKeyringRing, setShowKeyringRing] = useState(false);
  const [keyringPosition, setKeyringPosition] = useState({ angle: 0, x: 0, y: 0 });

  // Tool state
  const [newText, setNewText] = useState("ÌÖçÏä§Ìä∏");
  const [fontSize, setFontSize] = useState(24);
  const [fontFamily, setFontFamily] = useState("Pretendard");
  const [textColor, setTextColor] = useState("#000000");
  const [shapeType, setShapeType] = useState("rectangle");
  const [shapeFill, setShapeFill] = useState("#FF0000");

  const isEditorEnabled = canvasSize !== null;
  const selectedElementData = elements.find(el => el.id === selectedElement);

  const handleSizeSet = useCallback((size) => {
    setCanvasSize(size);
    toast({
      title: "Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ïÎê®",
      description: `${size.widthMM}mm √ó ${size.heightMM}mm (${size.width}px √ó ${size.height}px)`,
    });
  }, [toast]);

  const handleCanvasResize = useCallback((newSize, maskData = null) => {
    setCanvasSize(newSize);
    setCanvasMask(maskData);
    
    const description = maskData 
      ? `Ïù¥ÎØ∏ÏßÄ Î™®ÏñëÏúºÎ°ú Ï°∞Ï†à: ${newSize.widthMM}mm √ó ${newSize.heightMM}mm (1cm Ïó¨Î∞±)`
      : `Ïù¥ÎØ∏ÏßÄÏóê ÎßûÍ≤å Ï°∞Ï†à: ${newSize.widthMM}mm √ó ${newSize.heightMM}mm (1cm Ïó¨Î∞± Ìè¨Ìï®)`;
      
    toast({
      title: "Ï∫îÎ≤ÑÏä§ ÏûêÎèô Ï°∞Ï†àÎê®",
      description: description,
    });
  }, [toast]);

  const saveToHistory = useCallback((newElements) => {
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push([...newElements]);
    setHistory(newHistory);
    setHistoryIndex(newHistory.length - 1);
  }, [history, historyIndex]);

  const handleUndo = useCallback(() => {
    if (historyIndex > 0) {
      setHistoryIndex(historyIndex - 1);
      setElements([...history[historyIndex - 1]]);
    }
  }, [history, historyIndex]);

  const handleRedo = useCallback(() => {
    if (historyIndex < history.length - 1) {
      setHistoryIndex(historyIndex + 1);
      setElements([...history[historyIndex + 1]]);
    }
  }, [history, historyIndex]);

  const updateElement = useCallback((id, updates) => {
    const newElements = elements.map((el) => el.id === id ? { ...el, ...updates } : el);
    setElements(newElements);
    saveToHistory(newElements);
  }, [elements, saveToHistory]);

  const addElement = useCallback((element) => {
    const newElements = [...elements, element];
    setElements(newElements);
    setSelectedElement(element.id);
    saveToHistory(newElements);
  }, [elements, saveToHistory]);

  const deleteElement = useCallback((id) => {
    const newElements = elements.filter((el) => el.id !== id);
    setElements(newElements);
    if (selectedElement === id) {
      setSelectedElement(null);
    }
    saveToHistory(newElements);
  }, [elements, selectedElement, saveToHistory]);

  // Í∞úÏÑ†Îêú Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
  const handleImageUpload = useCallback(async (e) => {
    const file = e.target.files?.[0];
    if (!file || !canvasSize) return;

    try {
      const imageData = await loadImageFile(file);
      
      // ÏûêÎèô Î¶¨ÏÇ¨Ïù¥Ï¶à Ï†ÅÏö©
      const resizedDimensions = autoResizeImage(
        { width: imageData.width, height: imageData.height },
        canvasSize,
        0.8 // Ï∫îÎ≤ÑÏä§Ïùò 80% ÌÅ¨Í∏∞Î°ú Ï†úÌïú
      );
      
      // Ï§ëÏïô Î∞∞Ïπò
      const centerPosition = getCenterPosition(resizedDimensions, canvasSize);
      
      const element = {
        id: `img-${Date.now()}`,
        type: "image",
        ...centerPosition,
        ...resizedDimensions,
        rotation: 0,
        visible: true,
        zIndex: elements.length,
        src: imageData.src,
        originalWidth: imageData.width,
        originalHeight: imageData.height,
        originalFile: file, // ÏõêÎ≥∏ ÌååÏùº Í∞ùÏ≤¥ Ï†ÄÏû• (Î∞∞Í≤Ω Ï†úÍ±∞Ïö©)
      };

      addElement(element);
      toast({
        title: "Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞ÄÎê®",
        description: `Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï∫îÎ≤ÑÏä§Ïóê ÎßûÍ≤å Î¶¨ÏÇ¨Ïù¥Ï¶àÎêòÏñ¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`,
      });
    } catch (error) {
      toast({
        title: "Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®",
        description: error.message,
        variant: "destructive"
      });
    }
  }, [canvasSize, elements, addElement, toast]);

  const handleAddText = useCallback(() => {
    if (!newText.trim() || !canvasSize) return;

    const element = {
      id: `text-${Date.now()}`,
      type: "text",
      x: canvasSize.width * 0.1,
      y: canvasSize.height * 0.1,
      width: canvasSize.width * 0.8,
      height: fontSize * 1.5,
      rotation: 0,
      visible: true,
      zIndex: elements.length,
      text: newText,
      fontSize,
      fontFamily,
      color: textColor,
    };

    addElement(element);
    setNewText("ÌÖçÏä§Ìä∏");
    toast({
      title: "ÌÖçÏä§Ìä∏ Ï∂îÍ∞ÄÎê®",
      description: "ÌÖçÏä§Ìä∏Í∞Ä Ï∫îÎ≤ÑÏä§Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.",
    });
  }, [newText, canvasSize, fontSize, fontFamily, textColor, elements, addElement, toast]);

  const handleAddShape = useCallback(() => {
    if (!canvasSize) return;

    const size = Math.min(canvasSize.width, canvasSize.height) * 0.2;
    const element = {
      id: `shape-${Date.now()}`,
      type: "shape",
      x: (canvasSize.width - size) / 2,
      y: (canvasSize.height - size) / 2,
      width: size,
      height: size,
      rotation: 0,
      visible: true,
      zIndex: elements.length,
      shapeType,
      fill: shapeFill,
    };

    addElement(element);
    toast({
      title: "ÎèÑÌòï Ï∂îÍ∞ÄÎê®",
      description: "ÎèÑÌòïÏù¥ Ï∫îÎ≤ÑÏä§Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.",
    });
  }, [canvasSize, shapeType, shapeFill, elements, addElement, toast]);

  const handleSave = useCallback(() => {
    const designData = {
      elements,
      canvasSize,
      timestamp: Date.now(),
    };

    localStorage.setItem("pinto-design", JSON.stringify(designData));
    toast({
      title: "ÎîîÏûêÏù∏ Ï†ÄÏû•Îê®",
      description: `${elements.length}Í∞úÏùò ÏöîÏÜåÍ∞Ä Ìè¨Ìï®Îêú ÎîîÏûêÏù∏Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`,
    });
  }, [elements, canvasSize, toast]);


  const handleExport = useCallback((format) => {
    if (!canvasSize || !canvasRef.current) {
      toast({
        title: "ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®",
        description: "Ï∫îÎ≤ÑÏä§Í∞Ä Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.",
        variant: "destructive"
      });
      return;
    }

    toast({
      title: `${format.toUpperCase()} ÎÇ¥Î≥¥ÎÇ¥Í∏∞`,
      description: "ÌååÏùºÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§.",
    });
  }, [canvasSize, toast]);

  return (
    <div className="h-screen bg-gray-100 flex flex-col">
      {/* Toast Container */}
      <div className="fixed top-4 right-4 z-50 space-y-2">
        {toasts.map((toast) => (
          <div
            key={toast.id}
            className={cn(
              "p-4 rounded-lg shadow-lg text-white max-w-sm",
              toast.variant === "destructive" ? "bg-red-600" : "bg-green-600"
            )}
          >
            <div className="font-medium">{toast.title}</div>
            {toast.description && (
              <div className="text-sm opacity-90">{toast.description}</div>
            )}
          </div>
        ))}
      </div>
      
      {/* Top Toolbar */}
      <div className="bg-gray-900 border-b border-gray-700 px-4 py-2 flex items-center justify-between">
        <div className="flex items-center space-x-2 text-gray-100">
          <span className="text-lg font-bold">PINTO</span>
          <span className="text-sm text-gray-400">ÍµøÏ¶à ÏóêÎîîÌÑ∞</span>
        </div>

        <div className="flex items-center space-x-2">
          <Button
            variant="ghost"
            size="sm"
            onClick={handleUndo}
            disabled={historyIndex <= 0}
            className="text-gray-200 hover:bg-gray-700 hover:text-white"
            title="ÎêòÎèåÎ¶¨Í∏∞ (Ctrl+Z)"
          >
            <Undo2 className="w-4 h-4" />
            ÎêòÎèåÎ¶¨Í∏∞
          </Button>
          <Button
            variant="ghost"
            size="sm"
            onClick={handleRedo}
            disabled={historyIndex >= history.length - 1}
            className="text-gray-200 hover:bg-gray-700 hover:text-white"
            title="Îã§ÏãúÏã§Ìñâ (Ctrl+Y)"
          >
            <Redo2 className="w-4 h-4" />
            Îã§ÏãúÏã§Ìñâ
          </Button>
          <div className="w-px h-6 bg-gray-700" />
          <Button
            variant="ghost"
            size="sm"
            onClick={() => selectedElement && deleteElement(selectedElement)}
            disabled={!selectedElement}
            className="text-gray-200 hover:bg-gray-700 hover:text-white"
            title="ÏÇ≠Ï†ú (Delete)"
          >
            <Trash2 className="w-4 h-4" />
            ÏÇ≠Ï†ú
          </Button>
          <div className="w-px h-6 bg-gray-700" />
          {canvasMask && (
            <Button
              variant="ghost"
              size="sm"
              onClick={() => {
                setCanvasMask(null);
                toast({
                  title: "Ï∫îÎ≤ÑÏä§ Î™®Ïñë Ï¥àÍ∏∞ÌôîÎê®",
                  description: "ÏÇ¨Í∞ÅÌòï Ï∫îÎ≤ÑÏä§Î°ú ÎèåÏïÑÍ∞îÏäµÎãàÎã§.",
                });
              }}
              className="text-yellow-400 hover:bg-gray-700 hover:text-yellow-300"
              title="ÏÇ¨Í∞ÅÌòï Ï∫îÎ≤ÑÏä§Î°ú Ï¥àÍ∏∞Ìôî"
            >
              <Square className="w-4 h-4" />
              Î™®Ïñë Ï¥àÍ∏∞Ìôî
            </Button>
          )}
          {showKeyringRing && (
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setShowKeyringRing(false)}
              className="text-yellow-400 hover:bg-gray-700 hover:text-yellow-300"
              title="ÌÇ§ÎßÅ Í≥†Î¶¨ Ïà®Í∏∞Í∏∞"
            >
              <div className="w-4 h-4 border-2 border-current rounded-full" />
              Í≥†Î¶¨ Ïà®Í∏∞Í∏∞
            </Button>
          )}
          <div className="w-px h-6 bg-gray-700" />
          <Button
            variant="ghost"
            size="sm"
            onClick={handleSave}
            className="text-gray-200 hover:bg-gray-700 hover:text-white"
            title="Ï†ÄÏû• (Ctrl+S)"
          >
            <Save className="w-4 h-4" />
            Ï†ÄÏû•
          </Button>
          <Button
            variant="ghost"
            size="sm"
            onClick={() => handleExport("png")}
            disabled={!isEditorEnabled}
            className="text-gray-200 hover:bg-gray-700 hover:text-white"
            title="PNG Îã§Ïö¥Î°úÎìú"
          >
            <Download className="w-4 h-4" />
            PNG
          </Button>
          <Button
            variant="default"
            size="sm"
            onClick={() => handleExport("pdf")}
            disabled={!isEditorEnabled}
            className="bg-blue-600 text-white hover:bg-blue-700"
            title="Í≥†Ìï¥ÏÉÅÎèÑ PDF Îã§Ïö¥Î°úÎìú"
          >
            PDF Îã§Ïö¥Î°úÎìú
          </Button>
        </div>
      </div>

      <div className="flex flex-1 overflow-hidden">
        {/* Left Sidebar */}
        <div className="w-64 bg-gray-800 text-white flex flex-col">
          {/* Size Selector */}
          <div className="p-4 border-b border-gray-700">
            <h3 className="text-sm font-medium mb-3">Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï</h3>
            {!canvasSize ? (
              <SizeSelector productType="keyring" onSizeSet={handleSizeSet} />
            ) : (
              <div className="space-y-2">
                <div className="text-xs text-gray-400">
                  ÌÅ¨Í∏∞: {canvasSize.widthMM}mm √ó {canvasSize.heightMM}mm
                </div>
                <div className="text-xs text-gray-500">
                  ({canvasSize.width}px √ó {canvasSize.height}px)
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setCanvasSize(null)}
                  className="w-full text-xs border-gray-600 text-gray-300 hover:bg-gray-700"
                >
                  ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω
                </Button>
              </div>
            )}
          </div>

          {/* Image Tools */}
          <ImageTools
            selectedImage={selectedElementData}
            onUpdateImage={updateElement}
            onRemoveBackground={(id, updates) => updateElement(id, updates)}
            onCanvasResize={handleCanvasResize}
            canvasSize={canvasSize}
            disabled={!isEditorEnabled}
          />

          {/* Tools */}
          <div className="flex-1 overflow-y-auto">
            {/* Image Upload */}
            <div className="p-4 border-b border-gray-700">
              <div className="flex items-center space-x-2 mb-3">
                <Upload className="w-4 h-4" />
                <span className="text-sm font-medium">Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</span>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={(e) => {
                  e.preventDefault();
                  if (fileInputRef.current) {
                    fileInputRef.current.click();
                  }
                }}
                disabled={!isEditorEnabled}
                className="w-full text-xs hover:bg-blue-600 hover:text-white border-blue-400 text-blue-400"
              >
                <Upload className="w-3 h-3 mr-1" />
                Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù
              </Button>
              <div className="text-xs text-gray-400 mt-2">
                JPG, PNG, GIF, WebP ÏßÄÏõê<br/>
                ÏûêÎèôÏúºÎ°ú Ï∫îÎ≤ÑÏä§Ïóê ÎßûÍ≤å Î¶¨ÏÇ¨Ïù¥Ï¶àÎê©ÎãàÎã§
              </div>
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*,image/jpeg,image/png,image/gif,image/webp"
                onChange={handleImageUpload}
                onClick={(e) => {
                  e.target.value = "";
                }}
                style={{ display: "none" }}
              />
            </div>

            {/* Text Tool */}
            <div className="p-4 border-b border-gray-700">
              <div className="flex items-center space-x-2 mb-3">
                <Type className="w-4 h-4" />
                <span className="text-sm font-medium">ÌÖçÏä§Ìä∏</span>
              </div>
              <div className="space-y-3">
                <Input
                  value={newText}
                  onChange={(e) => setNewText(e.target.value)}
                  placeholder="ÌÖçÏä§Ìä∏ ÏûÖÎ†•"
                  disabled={!isEditorEnabled}
                  className="bg-gray-700 border-gray-600 text-white text-xs"
                />
                <Select value={fontFamily} onValueChange={setFontFamily} disabled={!isEditorEnabled}>
                  <option value="Pretendard">Pretendard</option>
                  <option value="Noto Sans KR">Noto Sans KR</option>
                  <option value="Arial">Arial</option>
                  <option value="Georgia">Georgia</option>
                </Select>
                <div className="flex space-x-2">
                  <Input
                    type="number"
                    value={fontSize}
                    onChange={(e) => setFontSize(Number(e.target.value))}
                    min="8"
                    max="72"
                    disabled={!isEditorEnabled}
                    className="bg-gray-700 border-gray-600 text-white text-xs"
                    placeholder="ÌÅ¨Í∏∞"
                  />
                  <Input
                    type="color"
                    value={textColor}
                    onChange={(e) => setTextColor(e.target.value)}
                    disabled={!isEditorEnabled}
                    className="bg-gray-700 border-gray-600 w-12"
                    title="ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ"
                  />
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleAddText}
                  disabled={!isEditorEnabled || !newText.trim()}
                  className="w-full text-xs hover:bg-green-600 hover:text-white border-green-400 text-green-400"
                >
                  <Type className="w-3 h-3 mr-1" />
                  ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
                </Button>
              </div>
            </div>

            {/* Shape Tool */}
            <div className="p-4 border-b border-gray-700">
              <div className="flex items-center space-x-2 mb-3">
                <Square className="w-4 h-4" />
                <span className="text-sm font-medium">ÎèÑÌòï</span>
              </div>
              <div className="space-y-3">
                <div className="flex space-x-2">
                  <Button
                    variant={shapeType === "rectangle" ? "default" : "outline"}
                    size="sm"
                    onClick={() => setShapeType("rectangle")}
                    disabled={!isEditorEnabled}
                    className={cn("w-full text-xs", shapeType !== "rectangle" && "border-gray-600 text-gray-300")}
                    title="ÏÇ¨Í∞ÅÌòï"
                  >
                    <Square className="w-3 h-3" />
                    ÏÇ¨Í∞ÅÌòïÎßå
                  </Button>
                </div>
                <div className="flex items-center space-x-2">
                  <Label className="text-xs text-gray-400">ÏÉâÏÉÅ</Label>
                  <Input
                    type="color"
                    value={shapeFill}
                    onChange={(e) => setShapeFill(e.target.value)}
                    disabled={!isEditorEnabled}
                    className="bg-gray-700 border-gray-600 flex-1"
                  />
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleAddShape}
                  disabled={!isEditorEnabled}
                  className={cn(
                    "w-full text-xs",
                    isEditorEnabled
                      ? "hover:bg-purple-600 hover:text-white border-purple-400 text-purple-400"
                      : "disabled:opacity-30 disabled:cursor-not-allowed"
                  )}
                >
                  <Square className="w-3 h-3 mr-1" />
                  ÎèÑÌòï Ï∂îÍ∞Ä
                </Button>
              </div>
            </div>

            {/* Keyring Tool */}
            <div className="p-4">
              <div className="flex items-center space-x-2 mb-3">
                <div className="w-4 h-4 border-2 border-yellow-500 rounded-full bg-yellow-200"></div>
                <span className="text-sm font-medium">ÌÇ§ÎßÅ Í≥†Î¶¨</span>
              </div>
              <div className="space-y-3">
                <Button
                  variant={showKeyringRing ? "default" : "outline"}
                  size="sm"
                  onClick={() => setShowKeyringRing(!showKeyringRing)}
                  disabled={!isEditorEnabled}
                  className={cn(
                    "w-full text-xs",
                    showKeyringRing
                      ? "bg-yellow-600 text-white hover:bg-yellow-700"
                      : "hover:bg-yellow-600 hover:text-white border-yellow-400 text-yellow-400"
                  )}
                >
                  <div className="w-3 h-3 border border-current rounded-full mr-1"></div>
                  {showKeyringRing ? 'Í≥†Î¶¨ Ïà®Í∏∞Í∏∞' : 'Í≥†Î¶¨ ÌëúÏãú'}
                </Button>
                <div className="text-xs text-gray-400">
                  ÏßÄÎ¶Ñ 1.5cm ÎèÑÎÑõ Î™®Ïñë Í≥†Î¶¨
                  <br />
                  ÎìúÎûòÍ∑∏Î°ú ÏúÑÏπò Ï°∞Ï†à Í∞ÄÎä•
                </div>
                {showKeyringRing && (
                  <div className="text-xs text-yellow-400 bg-yellow-900/20 p-2 rounded">
                    üí° Í≥†Î¶¨Î•º ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏõêÌïòÎäî ÏúÑÏπòÎ°ú Ïù¥ÎèôÌïòÏÑ∏Ïöî
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Main Canvas Area */}
        <div className="flex-1 bg-gray-100 overflow-auto">
          {canvasSize ? (
            <div className="h-full flex items-center justify-center p-8">
              <div className="relative canvas-container">
                <div
                  ref={canvasRef}
                  className={cn(
                    "relative bg-white shadow-xl overflow-visible",
                    canvasMask ? "border-2 border-blue-500" : "border-2 border-dashed border-gray-400"
                  )}
                  style={{
                    width: canvasSize.width,
                    height: canvasSize.height,
                    minWidth: canvasSize.width,
                    minHeight: canvasSize.height,
                    // Ï∫îÎ≤ÑÏä§Î•º Ïù¥ÎØ∏ÏßÄ Î™®ÏñëÏúºÎ°ú ÌÅ¥Î¶¨Ìïë
                    ...(canvasMask && {
                      clipPath: `polygon(${canvasMask.contour.map(point => 
                        `${(point.x / canvasSize.width * 100).toFixed(2)}% ${(point.y / canvasSize.height * 100).toFixed(2)}%`
                      ).join(', ')})`,
                    })
                  }}
                  onClick={(e) => {
                    if (e.target === canvasRef.current) {
                      setSelectedElement(null);
                    }
                  }}
                >
                  {/* Keyring Ring */}
                  <KeyringRing
                    canvasSize={canvasSize}
                    isVisible={showKeyringRing}
                    onPositionChange={setKeyringPosition}
                  />
                  {/* Canvas Grid Background */}
                  <div
                    className="absolute inset-0 opacity-5 pointer-events-none"
                    style={{
                      backgroundImage: `
                        linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)
                      `,
                      backgroundSize: "20px 20px",
                    }}
                  />

                  {/* Canvas Elements */}
                  {elements
                    .filter((el) => el.visible)
                    .sort((a, b) => a.zIndex - b.zIndex)
                    .map((element) => (
                      <DraggableElement
                        key={element.id}
                        element={element}
                        isSelected={selectedElement === element.id}
                        onSelect={setSelectedElement}
                        onUpdate={updateElement}
                        onDelete={deleteElement}
                        canvasBounds={canvasSize}
                      />
                    ))}


                  {/* Empty State */}
                  {elements.length === 0 && (
                    <div className="absolute inset-0 flex items-center justify-center text-gray-400 pointer-events-none">
                      <div className="text-center">
                        <div className="text-lg font-medium mb-2">
                          Ïó¨Í∏∞Ïóê Ïù¥ÎØ∏ÏßÄÎÇò ÌÖçÏä§Ìä∏Î•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî
                        </div>
                        <div className="text-sm text-gray-400">
                          {canvasSize.widthMM}mm √ó {canvasSize.heightMM}mm Ï∫îÎ≤ÑÏä§
                        </div>
                        <div className="text-xs text-gray-400 mt-1">
                          Ïù¥ÎØ∏ÏßÄÎäî ÏûêÎèôÏúºÎ°ú Ï∫îÎ≤ÑÏä§Ïóê ÎßûÍ≤å Î¶¨ÏÇ¨Ïù¥Ï¶àÎê©ÎãàÎã§
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Canvas Info */}
                <div className="absolute -bottom-8 left-0 right-0 text-center">
                  <div className="text-xs text-gray-500">
                    Ï∫îÎ≤ÑÏä§: {canvasSize.widthMM}mm √ó {canvasSize.heightMM}mm 
                    ({canvasSize.width}px √ó {canvasSize.height}px)
                    {elements.length > 0 && ` | ${elements.length}Í∞ú ÏöîÏÜå`}
                    {showKeyringRing && " | ÌÇ§ÎßÅ Í≥†Î¶¨ ÌëúÏãúÎê®"}
                  </div>
                  {showKeyringRing && (
                    <div className="text-xs text-yellow-600 mt-1">
                      üîó Í≥†Î¶¨ ÏúÑÏπò: {Math.round((keyringPosition.angle * 180) / Math.PI)}¬∞ 
                      ({Math.round(keyringPosition.x)}, {Math.round(keyringPosition.y)})
                    </div>
                  )}
                </div>
              </div>
            </div>
          ) : (
            <div className="h-full flex items-center justify-center">
              <div className="text-center text-gray-500">
                <Upload className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                <div className="text-xl font-medium mb-2">Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî</div>
                <div className="text-sm">ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú Ï†úÌíà ÌÉÄÏûÖÍ≥º ÌÅ¨Í∏∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
                <div className="text-xs text-gray-400 mt-2">
                  ÌÇ§ÎßÅ, Ïä§Ìã∞Ïª§, Ìè∞ÏºÄÏù¥Ïä§ Îì± Îã§ÏñëÌïú ÍµøÏ¶à Ï†úÏûëÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}